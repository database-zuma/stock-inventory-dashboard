<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Inventory - Stock Retail & Warehouse</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --secondary: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            min-height: 100vh;
            color: #1f2937;
        }

        .header {
            background: var(--bg-gradient);
            padding: 25px 40px;
            color: white;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
        }

        /* Filter Section */
        .filter-section {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-end;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-group select, .filter-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 0.95rem;
            font-family: 'Poppins', sans-serif;
            background: white;
            transition: all 0.3s ease;
        }

        .filter-group select:focus, .filter-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
        }

        .btn-primary {
            background: var(--bg-gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            border-radius: 20px 20px 0 0;
        }

        .stat-card.primary::before { background: var(--primary); }
        .stat-card.success::before { background: var(--success); }
        .stat-card.warning::before { background: var(--warning); }
        .stat-card.info::before { background: var(--info); }
        .stat-card.danger::before { background: var(--danger); }
        .stat-card.secondary::before { background: var(--secondary); }

        .stat-card h3 {
            font-size: 0.85rem;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
        }

        .stat-card .sub-value {
            font-size: 0.85rem;
            color: #9ca3af;
            margin-top: 5px;
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--shadow);
        }

        .chart-card h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #374151;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Data Table */
        .table-section {
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .table-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #374151;
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 10px 16px 10px 40px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 0.9rem;
            width: 300px;
            font-family: 'Poppins', sans-serif;
        }

        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.9rem;
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 14px 15px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.9rem;
        }

        tr:hover {
            background: #f8fafc;
        }

        tr:nth-child(even) {
            background: #fafbfc;
        }

        tr:nth-child(even):hover {
            background: #f0f4f8;
        }

        .stock-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .stock-high { background: #d1fae5; color: #065f46; }
        .stock-medium { background: #fef3c7; color: #92400e; }
        .stock-low { background: #fee2e2; color: #991b1b; }
        .stock-zero { background: #f3f4f6; color: #6b7280; }
        .stock-negative { background: #fecaca; color: #dc2626; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 30px;
            background: var(--card-bg);
            padding: 8px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            width: fit-content;
        }

        .tab {
            padding: 12px 25px;
            border: none;
            background: transparent;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            color: #6b7280;
        }

        .tab:hover {
            background: #f3f4f6;
        }

        .tab.active {
            background: var(--bg-gradient);
            color: white;
        }

        /* Entity Pills */
        .entity-pills {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .entity-pill {
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .entity-pill.ddd { background: #dbeafe; color: #1d4ed8; border-color: #93c5fd; }
        .entity-pill.ljbb { background: #dcfce7; color: #15803d; border-color: #86efac; }
        .entity-pill.mbb { background: #fef3c7; color: #b45309; border-color: #fcd34d; }
        .entity-pill.ubb { background: #fce7f3; color: #be185d; border-color: #f9a8d4; }

        .entity-pill.active {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px;
            color: #6b7280;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .filter-section { padding: 20px; }
            .charts-grid { grid-template-columns: 1fr; }
            .search-box input { width: 200px; }
        }

        /* Upload Section */
        .upload-section {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .upload-zone {
            border: 3px dashed #e5e7eb;
            border-radius: 16px;
            padding: 40px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .upload-zone h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #374151;
        }

        .upload-zone p {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .file-input {
            display: none;
        }

        .uploaded-files {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }

        .file-tag {
            background: #e0e7ff;
            color: #3730a3;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-tag .remove {
            cursor: pointer;
            opacity: 0.7;
        }

        .file-tag .remove:hover {
            opacity: 1;
        }

        /* Summary Grid */
        .summary-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-item .label {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-item .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }

        /* Progress bar */
        .progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-fill.green { background: linear-gradient(90deg, #10b981, #34d399); }
        .progress-fill.yellow { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .progress-fill.red { background: linear-gradient(90deg, #ef4444, #f87171); }
    </style>
</head>
<body>
    <div class="header">
        <h1>Dashboard Inventory</h1>
        <p>Monitoring Stock Retail & Warehouse - DDD, LJBB, MBB, UBB</p>
    </div>

    <div class="container">
        <!-- Upload Section -->
        <div class="upload-section" id="uploadSection">
            <div class="upload-zone" id="uploadZone">
                <h3>üìÅ Upload File CSV Stock</h3>
                <p>Drag & drop file CSV atau klik untuk memilih file</p>
                <p style="margin-top: 10px; font-size: 0.8rem; color: #9ca3af;">
                    Supported: Stock WH DDD.csv, Stock WH LJBB.csv, Stock WH MBB.csv, Stock WH UBB.csv, Stok Retail DDD.csv
                </p>
            </div>
            <input type="file" id="fileInput" class="file-input" multiple accept=".csv">
            <div class="uploaded-files" id="uploadedFiles"></div>
        </div>

        <!-- Entity Pills -->
        <div class="entity-pills">
            <div class="entity-pill ddd active" data-entity="DDD" onclick="selectEntity('DDD')">
                üè¢ DDD (Dream Dare Discover)
            </div>
            <div class="entity-pill ljbb" data-entity="LJBB" onclick="selectEntity('LJBB')">
                üè¢ LJBB (Lancar Jaya Besar Bersama)
            </div>
            <div class="entity-pill mbb" data-entity="MBB" onclick="selectEntity('MBB')">
                üè¢ MBB (Makmur Besar Bersama)
            </div>
            <div class="entity-pill ubb" data-entity="UBB" onclick="selectEntity('UBB')">
                üè¢ UBB (Untung Besar Bersama)
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-type="warehouse" onclick="switchTab('warehouse')">üì¶ Warehouse</button>
            <button class="tab" data-type="retail" onclick="switchTab('retail')">üè™ Retail Store</button>
            <button class="tab" data-type="comparison" onclick="switchTab('comparison')">üìä Comparison</button>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card primary">
                <h3>Total SKU</h3>
                <div class="value" id="totalSku">0</div>
                <div class="sub-value">Artikel terdaftar</div>
            </div>
            <div class="stat-card success">
                <h3>Stock Tersedia</h3>
                <div class="value" id="totalStock">0</div>
                <div class="sub-value">Total unit</div>
            </div>
            <div class="stat-card warning">
                <h3>Low Stock</h3>
                <div class="value" id="lowStock">0</div>
                <div class="sub-value">SKU di bawah 10 unit</div>
            </div>
            <div class="stat-card danger">
                <h3>Out of Stock</h3>
                <div class="value" id="outOfStock">0</div>
                <div class="sub-value">SKU dengan stok 0</div>
            </div>
            <div class="stat-card info">
                <h3>Negative Stock</h3>
                <div class="value" id="negativeStock">0</div>
                <div class="sub-value">Perlu adjustment</div>
            </div>
            <div class="stat-card secondary">
                <h3>High Stock</h3>
                <div class="value" id="highStock">0</div>
                <div class="sub-value">SKU > 100 unit</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid" id="chartsSection">
            <div class="chart-card">
                <h3>üìä Distribusi Stock per Kategori</h3>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>üìà Stock per Gender</h3>
                <div class="chart-container">
                    <canvas id="genderChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-group">
                <label>Kategori</label>
                <select id="filterCategory">
                    <option value="">Semua Kategori</option>
                    <option value="BABY">Baby</option>
                    <option value="BOYS">Boys</option>
                    <option value="GIRLS">Girls</option>
                    <option value="JUNIOR">Junior</option>
                    <option value="LADIES">Ladies</option>
                    <option value="MEN">Men</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Status Stock</label>
                <select id="filterStatus">
                    <option value="">Semua Status</option>
                    <option value="high">High Stock (>100)</option>
                    <option value="medium">Medium Stock (10-100)</option>
                    <option value="low">Low Stock (1-9)</option>
                    <option value="zero">Out of Stock (0)</option>
                    <option value="negative">Negative Stock</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Series/Tipe</label>
                <select id="filterSeries">
                    <option value="">Semua Series</option>
                    <option value="CLASSIC">Classic</option>
                    <option value="COLLAB">Collab</option>
                    <option value="DISNEY">Disney</option>
                    <option value="TOY STORY">Toy Story</option>
                    <option value="BATMAN">Batman</option>
                    <option value="COCOMELON">Cocomelon</option>
                    <option value="PRINCESS">Princess</option>
                    <option value="HELLO KITTY">Hello Kitty</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="applyFilters()">üîç Apply Filter</button>
            <button class="btn btn-secondary" onclick="resetFilters()">‚Ü∫ Reset</button>
        </div>

        <!-- Data Table -->
        <div class="table-section">
            <div class="table-header">
                <h3 id="tableTitle">üìã Data Stock Warehouse</h3>
                <div class="table-actions">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="Cari SKU atau Nama Barang..." oninput="searchData()">
                    </div>
                    <button class="btn btn-secondary" onclick="exportData()">üì• Export CSV</button>
                </div>
            </div>
            <div class="table-wrapper">
                <table id="dataTable">
                    <thead>
                        <tr id="tableHead">
                            <th>Kode SKU</th>
                            <th>Nama Barang</th>
                            <th>Size</th>
                            <th>Kategori</th>
                            <th>Total Stock</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="6" class="loading">
                                <div class="loading-spinner"></div>
                                Upload file CSV untuk melihat data
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Global data storage
        let allData = {
            DDD: { warehouse: [], retail: [] },
            LJBB: { warehouse: [], retail: [] },
            MBB: { warehouse: [], retail: [] },
            UBB: { warehouse: [], retail: [] }
        };

        let currentEntity = 'DDD';
        let currentType = 'warehouse';
        let filteredData = [];
        let categoryChart = null;
        let genderChart = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupUpload();
        });

        // Upload handlers
        function setupUpload() {
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');

            uploadZone.addEventListener('click', () => fileInput.click());

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (file.name.endsWith('.csv')) {
                    parseCSVFile(file);
                }
            });
        }

        function parseCSVFile(file) {
            const fileName = file.name.toLowerCase();
            console.log('=== PARSING FILE ===');
            console.log('File name:', file.name);
            console.log('File name lowercase:', fileName);

            // Determine entity and type from filename
            let entity = '';
            let type = '';

            if (fileName.includes('ddd')) entity = 'DDD';
            else if (fileName.includes('ljbb')) entity = 'LJBB';
            else if (fileName.includes('mbb')) entity = 'MBB';
            else if (fileName.includes('ubb')) entity = 'UBB';

            if (fileName.includes('retail') || fileName.includes('store')) type = 'retail';
            else if (fileName.includes('wh') || fileName.includes('warehouse')) type = 'warehouse';

            console.log('Detected entity:', entity, 'type:', type);

            if (!entity || !type) {
                alert('File tidak dikenali. Pastikan nama file mengandung nama entitas (DDD/LJBB/MBB/UBB) dan tipe (WH/Retail)');
                return;
            }

            Papa.parse(file, {
                delimiter: ';',  // CSV menggunakan semicolon separator
                skipEmptyLines: true,
                complete: (results) => {
                    const data = processCSVData(results.data, entity, type);
                    allData[entity][type] = data;

                    // Update uploaded files display
                    updateUploadedFiles(file.name, entity, type);

                    // Refresh display
                    updateDisplay();
                },
                error: (error) => {
                    console.error('Error parsing CSV:', error);
                    alert('Error parsing file: ' + file.name);
                }
            });
        }

        function processCSVData(rawData, entity, type) {
            const processedData = [];
            let headers = [];
            let dataStartRow = 0;

            // Find header row (row with 'Kode Barang' or similar)
            for (let i = 0; i < Math.min(10, rawData.length); i++) {
                const row = rawData[i];
                const rowStr = row.join('').toLowerCase();
                if (rowStr.includes('kode barang') || rowStr.includes('kode')) {
                    headers = row;
                    dataStartRow = i + 1;
                    break;
                }
            }

            // Find column indices
            let skuColIndex = -1;
            let nameColIndex = -1;
            let totalColIndex = -1;

            headers.forEach((header, idx) => {
                const h = (header || '').toLowerCase().replace(/\r/g, '').trim();
                if (h.includes('kode barang') || h === 'kode') skuColIndex = idx;
                if (h.includes('nama barang')) nameColIndex = idx;
                if (h.includes('total')) totalColIndex = idx;
            });

            // Debug: log column indices
            console.log('Headers:', headers);
            console.log('Total column index:', totalColIndex);

            // Process data rows
            for (let i = dataStartRow; i < rawData.length; i++) {
                const row = rawData[i];
                if (!row || row.length < 2) continue;

                // Get SKU (try multiple columns)
                let sku = '';
                for (let j = 0; j < row.length; j++) {
                    const val = (row[j] || '').trim();
                    if (val && /^[A-Z0-9]{5,}$/i.test(val) && !val.includes(' ')) {
                        sku = val;
                        break;
                    }
                }

                if (!sku || sku.toLowerCase() === 'total') continue;

                // Get name
                let name = '';
                if (nameColIndex >= 0 && row[nameColIndex]) {
                    name = (row[nameColIndex] || '').trim();
                }
                if (!name) {
                    for (let j = 0; j < row.length; j++) {
                        const val = (row[j] || '').trim();
                        if (val && val.length > 10 && val.includes(',')) {
                            name = val;
                            break;
                        }
                    }
                }

                // Get total stock - cari kolom dengan header "Total"
                let total = 0;
                let totalFound = false;

                // Method 1: Gunakan kolom Total yang terdeteksi dari header
                if (totalColIndex >= 0 && row[totalColIndex] !== undefined) {
                    const rawTotal = (row[totalColIndex] || '0').toString().replace(/\r/g, '').trim();
                    if (rawTotal !== '') {
                        total = parseNumber(rawTotal);
                        totalFound = true;
                    }
                }

                // Method 2: Fallback - cari kolom terakhir yang berisi angka
                if (!totalFound) {
                    for (let j = row.length - 1; j >= 0; j--) {
                        const cellValue = (row[j] || '').toString().replace(/\r/g, '').trim();
                        // Skip kolom kosong
                        if (cellValue === '') continue;
                        // Cek apakah ini angka (termasuk 0 dan negatif)
                        if (/^-?\d+$/.test(cellValue) || /^-?\d+[.,]\d+$/.test(cellValue)) {
                            total = parseNumber(cellValue);
                            totalFound = true;
                            break;
                        }
                    }
                }

                // Extract info from name
                const info = extractProductInfo(name, sku);

                processedData.push({
                    sku: sku,
                    name: name || sku,
                    size: info.size,
                    category: info.category,
                    gender: info.gender,
                    series: info.series,
                    total: total,
                    entity: entity,
                    type: type
                });
            }

            // Debug: tampilkan jumlah item per status stok
            const zeroStock = processedData.filter(item => Number(item.total) === 0);
            const negativeStock = processedData.filter(item => Number(item.total) < 0);
            const lowStock = processedData.filter(item => Number(item.total) > 0 && Number(item.total) < 10);
            console.log('=== DEBUG STOCK (' + entity + ' ' + type + ') ===');
            console.log('Total items parsed:', processedData.length);
            console.log('Items with stock = 0 (Out of Stock):', zeroStock.length);
            console.log('Items with stock < 0 (Negative):', negativeStock.length);
            console.log('Items with stock 1-9 (Low Stock):', lowStock.length);
            console.log('SKU Col Index:', skuColIndex, 'Name Col Index:', nameColIndex, 'Total Col Index:', totalColIndex);
            if (zeroStock.length > 0) {
                console.log('Sample zero stock items:', zeroStock.slice(0, 3));
            }
            if (zeroStock.length === 0) {
                console.log('WARNING: No zero stock found! Sample data:', processedData.slice(0, 3));
            }

            return processedData;
        }

        function parseNumber(val) {
            if (val === null || val === undefined) return 0;
            // Handle European number format (comma as decimal separator)
            let str = val.toString().replace(/[""]/g, '').replace(/\r/g, '').trim();
            // Remove thousand separators (.)
            str = str.replace(/\./g, '');
            // Replace comma with dot for decimal
            str = str.replace(',', '.');
            const num = parseFloat(str);
            return isNaN(num) ? 0 : Math.round(num);
        }

        function extractProductInfo(name, sku) {
            const info = {
                size: '',
                category: '',
                gender: '',
                series: ''
            };

            const upperName = (name || '').toUpperCase();
            const upperSku = (sku || '').toUpperCase();

            // Extract size from SKU (last 2-3 digits after Z)
            const sizeMatch = upperSku.match(/Z(\d{2,3})$/);
            if (sizeMatch) info.size = sizeMatch[1];

            // Extract size from name
            const nameSizeMatch = upperName.match(/(\d{2}\/?\d{2}|\d{2})/);
            if (nameSizeMatch && !info.size) info.size = nameSizeMatch[1];

            // Category detection
            if (upperName.includes('BABY') || upperSku.startsWith('Z') || upperSku.startsWith('BB')) {
                info.category = 'BABY';
            } else if (upperName.includes('BOYS') || upperSku.startsWith('B2') || upperSku.startsWith('B1')) {
                info.category = 'BOYS';
            } else if (upperName.includes('GIRLS') || upperSku.startsWith('G2') || upperSku.startsWith('G1')) {
                info.category = 'GIRLS';
            } else if (upperName.includes('JUNIOR') || upperSku.startsWith('J')) {
                info.category = 'JUNIOR';
            } else if (upperName.includes('LADIES') || upperSku.startsWith('L')) {
                info.category = 'LADIES';
            } else if (upperName.includes('MEN') || upperSku.startsWith('M')) {
                info.category = 'MEN';
            }

            // Gender detection
            if (upperName.includes('GIRLS') || upperName.includes('LADIES') || upperName.includes('PRINCESS') || upperName.includes('MINNIE')) {
                info.gender = 'Female';
            } else if (upperName.includes('BOYS') || upperName.includes('MEN') || upperName.includes('BATMAN')) {
                info.gender = 'Male';
            } else {
                info.gender = 'Unisex';
            }

            // Series detection
            const seriesPatterns = ['CLASSIC', 'COLLAB', 'DISNEY', 'TOY STORY', 'BATMAN', 'COCOMELON', 'PRINCESS', 'HELLO KITTY', 'MICKEY', 'MINNIE', 'OXFORD', 'MILTON'];
            for (const series of seriesPatterns) {
                if (upperName.includes(series)) {
                    info.series = series;
                    break;
                }
            }

            return info;
        }

        function updateUploadedFiles(fileName, entity, type) {
            const container = document.getElementById('uploadedFiles');
            const tag = document.createElement('div');
            tag.className = 'file-tag';
            tag.innerHTML = `
                <span>‚úì ${fileName}</span>
                <span class="remove" onclick="this.parentElement.remove()">√ó</span>
            `;
            container.appendChild(tag);
        }

        function selectEntity(entity) {
            currentEntity = entity;
            document.querySelectorAll('.entity-pill').forEach(pill => {
                pill.classList.remove('active');
                if (pill.dataset.entity === entity) {
                    pill.classList.add('active');
                }
            });
            updateDisplay();
        }

        function switchTab(type) {
            currentType = type;
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.type === type) {
                    tab.classList.add('active');
                }
            });

            // Update table title
            const titles = {
                warehouse: 'üì¶ Data Stock Warehouse',
                retail: 'üè™ Data Stock Retail Store',
                comparison: 'üìä Comparison Warehouse vs Retail'
            };
            document.getElementById('tableTitle').textContent = titles[type] || 'Data Stock';

            updateDisplay();
        }

        function updateDisplay() {
            let data = [];

            if (currentType === 'comparison') {
                // Merge warehouse and retail data for comparison
                data = [...allData[currentEntity].warehouse, ...allData[currentEntity].retail];
            } else {
                data = allData[currentEntity][currentType] || [];
            }

            filteredData = data;
            updateStats(data);
            updateCharts(data);
            renderTable(data);
        }

        function updateStats(data) {
            const stats = {
                totalSku: data.length,
                totalStock: 0,
                lowStock: 0,
                outOfStock: 0,
                negativeStock: 0,
                highStock: 0
            };

            data.forEach(item => {
                const total = Number(item.total) || 0;
                stats.totalStock += total;
                if (total < 0) stats.negativeStock++;
                else if (total === 0) stats.outOfStock++;
                else if (total < 10) stats.lowStock++;
                else if (total > 100) stats.highStock++;
            });

            document.getElementById('totalSku').textContent = stats.totalSku.toLocaleString();
            document.getElementById('totalStock').textContent = stats.totalStock.toLocaleString();
            document.getElementById('lowStock').textContent = stats.lowStock.toLocaleString();
            document.getElementById('outOfStock').textContent = stats.outOfStock.toLocaleString();
            document.getElementById('negativeStock').textContent = stats.negativeStock.toLocaleString();
            document.getElementById('highStock').textContent = stats.highStock.toLocaleString();
        }

        function updateCharts(data) {
            // Category distribution
            const categoryData = {};
            const genderData = { Male: 0, Female: 0, Unisex: 0 };

            data.forEach(item => {
                const cat = item.category || 'Other';
                categoryData[cat] = (categoryData[cat] || 0) + Math.max(0, item.total);

                const gender = item.gender || 'Unisex';
                genderData[gender] = (genderData[gender] || 0) + Math.max(0, item.total);
            });

            // Category Chart
            const ctxCategory = document.getElementById('categoryChart').getContext('2d');
            if (categoryChart) categoryChart.destroy();

            categoryChart = new Chart(ctxCategory, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryData),
                    datasets: [{
                        data: Object.values(categoryData),
                        backgroundColor: [
                            '#6366f1', '#ec4899', '#10b981', '#f59e0b', '#06b6d4', '#8b5cf6'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: { family: 'Poppins' },
                                padding: 15
                            }
                        }
                    }
                }
            });

            // Gender Chart
            const ctxGender = document.getElementById('genderChart').getContext('2d');
            if (genderChart) genderChart.destroy();

            genderChart = new Chart(ctxGender, {
                type: 'bar',
                data: {
                    labels: Object.keys(genderData),
                    datasets: [{
                        label: 'Total Stock',
                        data: Object.values(genderData),
                        backgroundColor: ['#3b82f6', '#ec4899', '#10b981'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { font: { family: 'Poppins' } }
                        },
                        x: {
                            ticks: { font: { family: 'Poppins' } }
                        }
                    }
                }
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');

            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="loading">
                            <div class="loading-spinner"></div>
                            Upload file CSV untuk melihat data
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = data.map(item => `
                <tr>
                    <td><strong>${item.sku}</strong></td>
                    <td>${item.name}</td>
                    <td>${item.size || '-'}</td>
                    <td>${item.category || '-'}</td>
                    <td><strong>${item.total.toLocaleString()}</strong></td>
                    <td>${getStockBadge(item.total)}</td>
                </tr>
            `).join('');
        }

        function getStockBadge(stock) {
            const s = Number(stock) || 0;
            if (s < 0) return '<span class="stock-badge stock-negative">Negative</span>';
            if (s === 0) return '<span class="stock-badge stock-zero">Out of Stock</span>';
            if (s < 10) return '<span class="stock-badge stock-low">Low Stock</span>';
            if (s > 100) return '<span class="stock-badge stock-high">High Stock</span>';
            return '<span class="stock-badge stock-medium">Normal</span>';
        }

        function applyFilters() {
            let data = [];

            if (currentType === 'comparison') {
                data = [...allData[currentEntity].warehouse, ...allData[currentEntity].retail];
            } else {
                data = allData[currentEntity][currentType] || [];
            }

            const categoryFilter = document.getElementById('filterCategory').value;
            const statusFilter = document.getElementById('filterStatus').value;
            const seriesFilter = document.getElementById('filterSeries').value;

            if (categoryFilter) {
                data = data.filter(item => (item.category || '').toUpperCase().includes(categoryFilter));
            }

            if (seriesFilter) {
                data = data.filter(item => (item.series || '').toUpperCase().includes(seriesFilter) ||
                                          (item.name || '').toUpperCase().includes(seriesFilter));
            }

            if (statusFilter) {
                switch(statusFilter) {
                    case 'high': data = data.filter(item => Number(item.total) > 100); break;
                    case 'medium': data = data.filter(item => Number(item.total) >= 10 && Number(item.total) <= 100); break;
                    case 'low': data = data.filter(item => Number(item.total) > 0 && Number(item.total) < 10); break;
                    case 'zero': data = data.filter(item => Number(item.total) === 0); break;
                    case 'negative': data = data.filter(item => Number(item.total) < 0); break;
                }
            }

            filteredData = data;
            updateStats(data);
            updateCharts(data);
            renderTable(data);
        }

        function resetFilters() {
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterSeries').value = '';
            document.getElementById('searchInput').value = '';
            updateDisplay();
        }

        function searchData() {
            const query = document.getElementById('searchInput').value.toLowerCase();

            let data = [];
            if (currentType === 'comparison') {
                data = [...allData[currentEntity].warehouse, ...allData[currentEntity].retail];
            } else {
                data = allData[currentEntity][currentType] || [];
            }

            if (query) {
                data = data.filter(item =>
                    item.sku.toLowerCase().includes(query) ||
                    (item.name || '').toLowerCase().includes(query)
                );
            }

            filteredData = data;
            renderTable(data);
        }

        function exportData() {
            if (!filteredData || filteredData.length === 0) {
                alert('Tidak ada data untuk di-export');
                return;
            }

            const headers = ['Kode SKU', 'Nama Barang', 'Size', 'Kategori', 'Gender', 'Series', 'Total Stock', 'Entity', 'Type'];
            const csvContent = [
                headers.join(','),
                ...filteredData.map(item => [
                    item.sku,
                    `"${(item.name || '').replace(/"/g, '""')}"`,
                    item.size || '',
                    item.category || '',
                    item.gender || '',
                    item.series || '',
                    item.total,
                    item.entity,
                    item.type
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `stock_${currentEntity}_${currentType}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
    </script>
</body>
</html>
