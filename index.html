<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Stock Retail & Warehouse - Zuma Indonesia</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1; --primary-light: #818cf8; --secondary: #ec4899;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --info: #06b6d4;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.98); --shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            background: #ffffff;
            min-height: 100vh; color: #1f2937;
        }
        .header {
            background: linear-gradient(135deg, #1f2937 0%, #111827 50%, #0f172a 100%); padding: 20px 40px; color: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header h1 { font-size: 1.6rem; font-weight: 700; }
        .header p { opacity: 0.9; font-size: 0.85rem; }
        .header .date { font-size: 0.8rem; opacity: 0.85; text-align: right; }
        .container { max-width: 1700px; margin: 0 auto; padding: 25px; }
        .loading { text-align: center; padding: 60px; color: #6b7280; }
        .loading-spinner {
            width: 50px; height: 50px; border: 4px solid #e5e7eb;
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Entity Pills */
        .entity-section { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin-bottom: 20px; }
        .entity-pills { display: flex; gap: 8px; flex-wrap: wrap; }
        .entity-pill {
            padding: 10px 20px; border-radius: 25px; font-size: 0.85rem;
            font-weight: 600; cursor: pointer; transition: all 0.3s ease;
            border: 2px solid transparent; display: flex; align-items: center; gap: 8px;
        }
        .entity-pill.ddd { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: 2px solid #b91c1c; }
        .entity-pill.ljbb { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: 2px solid #1d4ed8; }
        .entity-pill.mbb { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: 2px solid #6d28d9; }
        .entity-pill.ubb { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: 2px solid #b45309; }
        .entity-pill.active { transform: scale(1.08); box-shadow: 0 6px 20px rgba(0,0,0,0.4); }
        .entity-pill .count { background: rgba(255,255,255,0.5); padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; }

        /* Tabs */
        .tabs { display: flex; gap: 5px; margin-bottom: 25px; background: var(--card-bg); padding: 6px; border-radius: 14px; box-shadow: var(--shadow); width: fit-content; }
        .tab {
            padding: 10px 22px; border: none; background: transparent; border-radius: 10px;
            font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif; color: #6b7280;
        }
        .tab:hover { background: #f3f4f6; }
        .tab.active { background: var(--bg-gradient); color: white; }

        /* View Toggle */
        .view-toggle { display: flex; gap: 5px; background: #f3f4f6; padding: 4px; border-radius: 10px; }
        .view-btn {
            padding: 8px 16px; border: none; background: transparent; border-radius: 8px;
            font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease;
            font-family: 'Poppins', sans-serif; color: #6b7280;
        }
        .view-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: var(--card-bg); border-radius: 16px; padding: 20px; box-shadow: var(--shadow); position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; border-radius: 16px 16px 0 0; }
        .stat-card.primary::before { background: linear-gradient(90deg, #6366f1, #818cf8); }
        .stat-card.success::before { background: linear-gradient(90deg, #10b981, #34d399); }
        .stat-card.warning::before { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .stat-card.info::before { background: linear-gradient(90deg, #06b6d4, #22d3ee); }
        .stat-card.danger::before { background: linear-gradient(90deg, #ef4444, #f87171); }
        .stat-card h3 { font-size: 0.7rem; color: #6b7280; font-weight: 600; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card .value { font-size: 1.6rem; font-weight: 700; color: #1f2937; }
        .stat-card .sub-value { font-size: 0.75rem; color: #9ca3af; margin-top: 3px; }

        /* Filter Section */
        .filter-section {
            background: var(--card-bg); border-radius: 16px; padding: 20px 25px;
            margin-bottom: 25px; box-shadow: var(--shadow);
            display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px;
            align-items: end;
        }
        .filter-group label { display: block; font-weight: 600; margin-bottom: 6px; color: #374151; font-size: 0.75rem; text-transform: uppercase; }
        .filter-group select, .filter-group input {
            width: 100%; padding: 10px 14px; border: 2px solid #e5e7eb;
            border-radius: 10px; font-size: 0.85rem; font-family: 'Poppins', sans-serif;
            background: white; transition: all 0.3s ease;
        }
        .filter-group select:focus, .filter-group input:focus { outline: none; border-color: var(--primary); }
        .btn { padding: 10px 20px; border: none; border-radius: 10px; font-size: 0.85rem; font-weight: 600; cursor: pointer; font-family: 'Poppins', sans-serif; }
        .btn-primary { background: var(--bg-gradient); color: white; }
        .btn-secondary { background: #f3f4f6; color: #374151; }

        /* Area Tags */
        .area-tags { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
        .area-tag {
            padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 500;
            cursor: pointer; transition: all 0.2s ease; border: 2px solid transparent;
        }
        .area-tag.bali { background: #dcfce7; color: #166534; }
        .area-tag.jakarta { background: #dbeafe; color: #1e40af; }
        .area-tag.jawa-timur { background: #fef3c7; color: #b45309; }
        .area-tag.lombok { background: #fce7f3; color: #be185d; }
        .area-tag.sulawesi { background: #e0e7ff; color: #4338ca; }
        .area-tag.sumatera { background: #ffedd5; color: #c2410c; }
        .area-tag.batam { background: #f3e8ff; color: #7c3aed; }
        .area-tag.all { background: #f3f4f6; color: #374151; }
        .area-tag.active { border-color: #1f2937; transform: scale(1.05); }

        /* Table */
        .table-section { background: var(--card-bg); border-radius: 16px; box-shadow: var(--shadow); overflow: hidden; }
        .table-header { padding: 18px 22px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
        .table-header h3 { font-size: 0.95rem; font-weight: 600; color: #374151; }
        .table-actions { display: flex; gap: 10px; align-items: center; }
        .search-box { position: relative; }
        .search-box input { padding: 9px 14px 9px 38px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.85rem; width: 260px; font-family: 'Poppins', sans-serif; }
        .search-box::before { content: 'üîç'; position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 0.85rem; }
        .table-wrapper { overflow-x: auto; max-height: 500px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        th {
            color: white; padding: 12px 14px; text-align: left; font-size: 0.75rem;
            font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
            position: sticky; top: 0; z-index: 10; cursor: pointer;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }
        th:hover { background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); }
        th.warehouse { background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%); }
        th.warehouse:hover { background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%); }
        td { padding: 11px 14px; border-bottom: 1px solid #f3f4f6; font-size: 0.82rem; }
        tr:hover { background: #f8fafc; }
        tr:nth-child(even) { background: #fafbfc; }

        .stock-badge { display: inline-block; padding: 3px 10px; border-radius: 15px; font-size: 0.7rem; font-weight: 600; }
        .stock-high { background: #d1fae5; color: #065f46; }
        .stock-medium { background: #fef3c7; color: #92400e; }
        .stock-low { background: #fee2e2; color: #991b1b; }
        .stock-zero { background: #f3f4f6; color: #6b7280; }

        .pagination { display: flex; justify-content: space-between; align-items: center; padding: 12px 22px; border-top: 1px solid #e5e7eb; }
        .page-info { font-size: 0.8rem; color: #6b7280; }
        .page-buttons { display: flex; gap: 4px; }
        .page-btn { padding: 6px 12px; border: 1px solid #e5e7eb; background: white; border-radius: 6px; cursor: pointer; font-size: 0.8rem; }
        .page-btn:hover { background: #f3f4f6; }
        .page-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        @media (max-width: 768px) {
            .container { padding: 15px; }
            .filter-section { grid-template-columns: 1fr 1fr; }
            .search-box input { width: 180px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>Monitoring Stock Inventory</h1>
            <p>Zuma Indonesia - Real-time Dashboard</p>
        </div>
        <div class="date" id="currentDate"></div>
    </div>

    <div class="container">
        <!-- Entity Pills -->
        <div class="entity-section">
            <div class="entity-pills">
                <div class="entity-pill ddd active" onclick="selectEntity('DDD')">
                    <span>DDD</span>
                    <span class="count" id="count-DDD">-</span>
                </div>
                <div class="entity-pill ljbb" onclick="selectEntity('LJBB')">
                    <span>LJBB</span>
                    <span class="count" id="count-LJBB">-</span>
                </div>
                <div class="entity-pill mbb" onclick="selectEntity('MBB')">
                    <span>MBB</span>
                    <span class="count" id="count-MBB">-</span>
                </div>
                <div class="entity-pill ubb" onclick="selectEntity('UBB')">
                    <span>UBB</span>
                    <span class="count" id="count-UBB">-</span>
                </div>
            </div>
            <div class="view-toggle">
                <button class="view-btn active" onclick="selectView('retail')">Retail</button>
                <button class="view-btn" onclick="selectView('warehouse')">Warehouse</button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card primary">
                <h3>Total SKU</h3>
                <div class="value" id="stat-sku">-</div>
                <div class="sub-value" id="stat-sku-sub">Loading...</div>
            </div>
            <div class="stat-card success">
                <h3>Total Stock</h3>
                <div class="value" id="stat-stock">-</div>
                <div class="sub-value" id="stat-stock-sub">Loading...</div>
            </div>
            <div class="stat-card info">
                <h3>Lokasi</h3>
                <div class="value" id="stat-locations">-</div>
                <div class="sub-value" id="stat-locations-sub">Loading...</div>
            </div>
            <div class="stat-card warning">
                <h3>Stock Rendah</h3>
                <div class="value" id="stat-low">-</div>
                <div class="sub-value">Qty &lt; 10</div>
            </div>
        </div>

        <!-- Area Tags -->
        <div class="area-tags" id="areaTags">
            <span class="area-tag all active" onclick="selectArea('all')">Semua Area</span>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-group">
                <label>Search</label>
                <input type="text" id="searchInput" placeholder="SKU atau Nama..." oninput="debounceSearch()">
            </div>
            <div class="filter-group">
                <label>Lokasi</label>
                <select id="filterLocation" onchange="loadData()">
                    <option value="">Semua Lokasi</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Stock</label>
                <select id="filterStock" onchange="loadData()">
                    <option value="">Semua Stock</option>
                    <option value="high">High (>50)</option>
                    <option value="medium">Medium (10-50)</option>
                    <option value="low">Low (<10)</option>
                    <option value="zero">Zero (0)</option>
                </select>
            </div>
            <div class="filter-group">
                <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
            </div>
        </div>

        <!-- Table Section -->
        <div class="table-section">
            <div class="table-header">
                <h3 id="tableTitle">Stock Inventory</h3>
                <div class="table-actions">
                    <span class="page-info" id="tableInfo">Loading...</span>
                </div>
            </div>
            <div class="table-wrapper">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th onclick="sortBy('sku_code')">SKU</th>
                            <th onclick="sortBy('product_name')">Nama Produk</th>
                            <th onclick="sortBy('location_name')">Lokasi</th>
                            <th onclick="sortBy('quantity')">Qty</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="4" class="loading"><div class="loading-spinner"></div>Memuat data...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination">
                <div class="page-info" id="pageInfo">-</div>
                <div class="page-buttons" id="pageButtons"></div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://usxmptrqsovoxvrburvp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzeG1wdHJxc292b3h2cmJ1cnZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxODA2NzMsImV4cCI6MjA4NDc1NjY3M30.JkznqF6YWFgg22ta9F8feZuFbRPkHqkpDnJdm2G4C5Q';

        // State
        let currentEntity = 'DDD';
        let currentView = 'retail';
        let currentArea = 'all';
        let currentPage = 1;
        let pageSize = 50;
        let totalRecords = 0;
        let sortColumn = 'sku_code';
        let sortDirection = 'asc';
        let searchTimeout = null;

        // Area mapping
        const areaMap = {
            'bali': ['ZUMA Dalung', 'ZUMA Kedonganan', 'ZUMA Kesiman', 'ZUMA Mall Bali Galeria', 'ZUMA Panjer',
                     'ZUMA Peguyangan', 'ZUMA Peliatan', 'ZUMA Penatih', 'ZUMA Singaraja', 'ZUMA Tabanan',
                     'ZUMA Tanah Lot', 'Zuma Bajra', 'Zuma Bangli', 'Zuma BatuBulan', 'Zuma Gianyar',
                     'Zuma Jembrana', 'Zuma Kapal', 'Zuma KarangAsem', 'Zuma Klungkung', 'Zuma Lebah Peliatan',
                     'Zuma Level 21', 'Zuma Lippo Bali', 'Zuma Living World', 'Zuma Mall Bali Icon',
                     'Zuma Monang Maning', 'Zuma Monkey Forest Ubud', 'Zuma Pemogan', 'Zuma Seririt', 'Zuma Uluwatu',
                     'Warehouse Bali Gatsu - Box', 'Warehouse Bali Gatsu - Protol', 'Warehouse Bali Gatsu Reject'],
            'jakarta': ['ZUMA MALL OF INDONESIA (MOI)', 'Zuma Bintaro Xchange', 'Zuma Lippo Mall Puri',
                        'Zuma Pluit Village Mall', 'Warehouse Pluit', 'Warehouse Pluit Reject', 'Warehouse Jakarta'],
            'jawa-timur': ['ZUMA GALAXY MALL', 'Zuma City Of Tomorrow Mall', 'Zuma Icon Mall Gresik',
                          'Zuma Lippo Batu', 'Zuma Lippo Sidoarjo', 'Zuma MATOS', 'Zuma Mall Olympic Garden',
                          'Zuma PTC', 'Zuma Royal Plaza', 'Zuma Sunrise Mall Mojokerto', 'Zuma Tunjungan Plaza 3',
                          'Warehouse Pusat', 'Warehouse Pusat Protol', 'Warehouse Pusat Reject'],
            'lombok': ['ZUMA Epicentrum', 'Zuma Mataram Lombok'],
            'sulawesi': ['Zuma Mega Mall Manado'],
            'sumatera': ['Zuma SKA MALL'],
            'batam': ['Zuma Nagoya Hill Batam']
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateDate();
            loadEntityCounts();
            loadData();
        });

        function updateDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('id-ID', options);
        }

        async function supabaseFetch(endpoint) {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`
                }
            });
            return response;
        }

        async function loadEntityCounts() {
            const entities = ['DDD', 'LJBB', 'MBB', 'UBB'];
            for (const entity of entities) {
                try {
                    const resp = await supabaseFetch(`inventory?entity=eq.${entity}&select=id&limit=1`);
                    const count = resp.headers.get('content-range')?.split('/')[1] || '0';
                    document.getElementById(`count-${entity}`).textContent = parseInt(count).toLocaleString();
                } catch (e) {
                    document.getElementById(`count-${entity}`).textContent = '-';
                }
            }
        }

        function selectEntity(entity) {
            currentEntity = entity;
            currentPage = 1;
            document.querySelectorAll('.entity-pill').forEach(p => p.classList.remove('active'));
            document.querySelector(`.entity-pill.${entity.toLowerCase()}`).classList.add('active');
            loadLocations();
            loadData();
        }

        function selectView(view) {
            currentView = view;
            currentPage = 1;
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            loadLocations();
            loadData();
        }

        function selectArea(area) {
            currentArea = area;
            currentPage = 1;
            document.querySelectorAll('.area-tag').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            loadData();
        }

        async function loadLocations() {
            try {
                const resp = await supabaseFetch(
                    `inventory?entity=eq.${currentEntity}&location_type=eq.${currentView}&select=location_name&limit=1000`
                );
                const data = await resp.json();
                const locations = [...new Set(data.map(d => d.location_name))].sort();

                const select = document.getElementById('filterLocation');
                select.innerHTML = '<option value="">Semua Lokasi</option>' +
                    locations.map(l => `<option value="${l}">${l}</option>`).join('');

                // Update area tags
                updateAreaTags(locations);
            } catch (e) {
                console.error('Error loading locations:', e);
            }
        }

        function updateAreaTags(locations) {
            const areas = new Set();
            locations.forEach(loc => {
                for (const [area, stores] of Object.entries(areaMap)) {
                    if (stores.some(s => loc.toLowerCase().includes(s.toLowerCase()) || s.toLowerCase().includes(loc.toLowerCase()))) {
                        areas.add(area);
                        break;
                    }
                }
            });

            const tagsHtml = '<span class="area-tag all ' + (currentArea === 'all' ? 'active' : '') + '" onclick="selectArea(\'all\')">Semua</span>' +
                [...areas].map(area =>
                    `<span class="area-tag ${area} ${currentArea === area ? 'active' : ''}" onclick="selectArea('${area}')">${area.replace('-', ' ').toUpperCase()}</span>`
                ).join('');

            document.getElementById('areaTags').innerHTML = tagsHtml;
        }

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentPage = 1;
                loadData();
            }, 300);
        }

        function buildQuery() {
            let query = `inventory?entity=eq.${currentEntity}&location_type=eq.${currentView}`;

            // Search
            const search = document.getElementById('searchInput').value.trim();
            if (search) {
                query += `&or=(sku_code.ilike.*${search}*,product_name.ilike.*${search}*)`;
            }

            // Location filter
            const location = document.getElementById('filterLocation').value;
            if (location) {
                query += `&location_name=eq.${encodeURIComponent(location)}`;
            }

            // Area filter
            if (currentArea !== 'all' && areaMap[currentArea]) {
                const stores = areaMap[currentArea];
                const orClause = stores.map(s => `location_name.ilike.*${s}*`).join(',');
                query += `&or=(${orClause})`;
            }

            // Stock filter
            const stockFilter = document.getElementById('filterStock').value;
            if (stockFilter === 'high') query += '&quantity=gt.50';
            else if (stockFilter === 'medium') query += '&quantity=gte.10&quantity=lte.50';
            else if (stockFilter === 'low') query += '&quantity=gt.0&quantity=lt.10';
            else if (stockFilter === 'zero') query += '&quantity=eq.0';

            return query;
        }

        async function loadData() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '<tr><td colspan="4" class="loading"><div class="loading-spinner"></div>Memuat data...</td></tr>';

            try {
                const baseQuery = buildQuery();

                // Get count first
                const countResp = await supabaseFetch(`${baseQuery}&select=id&limit=1`);
                totalRecords = parseInt(countResp.headers.get('content-range')?.split('/')[1] || '0');

                // Get paginated data
                const offset = (currentPage - 1) * pageSize;
                const dataQuery = `${baseQuery}&select=*&order=${sortColumn}.${sortDirection}&limit=${pageSize}&offset=${offset}`;
                const dataResp = await supabaseFetch(dataQuery);
                const data = await dataResp.json();

                renderTable(data);
                renderPagination();
                updateStats(data);

            } catch (e) {
                console.error('Error loading data:', e);
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#ef4444;padding:40px;">Error memuat data. Coba refresh halaman.</td></tr>';
            }
        }

        function renderTable(data) {
            const tableBody = document.getElementById('tableBody');

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:40px;color:#6b7280;">Tidak ada data ditemukan</td></tr>';
                return;
            }

            tableBody.innerHTML = data.map(row => `
                <tr>
                    <td><strong>${row.sku_code || '-'}</strong></td>
                    <td>${row.product_name || '-'}</td>
                    <td>${row.location_name || '-'}</td>
                    <td><span class="stock-badge ${getStockClass(row.quantity)}">${row.quantity?.toLocaleString() || 0}</span></td>
                </tr>
            `).join('');

            document.getElementById('tableInfo').textContent = `${totalRecords.toLocaleString()} records`;
        }

        function getStockClass(qty) {
            if (qty > 50) return 'stock-high';
            if (qty >= 10) return 'stock-medium';
            if (qty > 0) return 'stock-low';
            return 'stock-zero';
        }

        function renderPagination() {
            const totalPages = Math.ceil(totalRecords / pageSize);
            const start = (currentPage - 1) * pageSize + 1;
            const end = Math.min(currentPage * pageSize, totalRecords);

            document.getElementById('pageInfo').textContent =
                totalRecords > 0 ? `${start}-${end} dari ${totalRecords.toLocaleString()}` : 'Tidak ada data';

            let buttons = '';
            buttons += `<button class="page-btn" onclick="goToPage(1)" ${currentPage === 1 ? 'disabled' : ''}>¬´</button>`;
            buttons += `<button class="page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‚Äπ</button>`;

            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                buttons += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }

            buttons += `<button class="page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''}>‚Ä∫</button>`;
            buttons += `<button class="page-btn" onclick="goToPage(${totalPages})" ${currentPage >= totalPages ? 'disabled' : ''}>¬ª</button>`;

            document.getElementById('pageButtons').innerHTML = buttons;
        }

        function goToPage(page) {
            const totalPages = Math.ceil(totalRecords / pageSize);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            loadData();
        }

        function sortBy(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            loadData();
        }

        async function updateStats(currentData) {
            // Total SKU (unique)
            document.getElementById('stat-sku').textContent = totalRecords.toLocaleString();
            document.getElementById('stat-sku-sub').textContent = `${currentView === 'retail' ? 'Retail' : 'Warehouse'} - ${currentEntity}`;

            // Calculate total stock from current filtered data
            try {
                const baseQuery = buildQuery();
                // Get sum - we need to fetch more data for accurate stats
                const statsResp = await supabaseFetch(`${baseQuery}&select=quantity,location_name&limit=10000`);
                const statsData = await statsResp.json();

                const totalStock = statsData.reduce((sum, d) => sum + (d.quantity || 0), 0);
                const uniqueLocations = new Set(statsData.map(d => d.location_name)).size;
                const lowStock = statsData.filter(d => d.quantity > 0 && d.quantity < 10).length;

                document.getElementById('stat-stock').textContent = totalStock.toLocaleString();
                document.getElementById('stat-stock-sub').textContent = 'Total quantity';

                document.getElementById('stat-locations').textContent = uniqueLocations.toLocaleString();
                document.getElementById('stat-locations-sub').textContent = currentView === 'retail' ? 'Toko' : 'Gudang';

                document.getElementById('stat-low').textContent = lowStock.toLocaleString();
            } catch (e) {
                console.error('Error updating stats:', e);
            }
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterLocation').value = '';
            document.getElementById('filterStock').value = '';
            currentArea = 'all';
            currentPage = 1;
            document.querySelectorAll('.area-tag').forEach(t => t.classList.remove('active'));
            document.querySelector('.area-tag.all')?.classList.add('active');
            loadData();
        }

        // Initial load
        loadLocations();
    </script>
</body>
</html>
