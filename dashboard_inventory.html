<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Stock Retail & Warehouse - Zuma Indonesia</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1; --primary-light: #818cf8; --secondary: #ec4899;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --info: #06b6d4;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.98); --shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            background: #ffffff;
            min-height: 100vh; color: #1f2937;
        }
        .header {
            background: linear-gradient(135deg, #1f2937 0%, #111827 50%, #0f172a 100%); padding: 20px 40px; color: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header h1 { font-size: 1.6rem; font-weight: 700; }
        .header p { opacity: 0.9; font-size: 0.85rem; }
        .header .date { font-size: 0.8rem; opacity: 0.85; text-align: right; }
        .container { max-width: 1700px; margin: 0 auto; padding: 25px; }

        .loading {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 60px; color: #6b7280;
        }
        .loading-spinner {
            width: 50px; height: 50px; border: 4px solid #e5e7eb;
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Entity Pills */
        .entity-section {
            display: flex; gap: 15px; align-items: center;
            flex-wrap: wrap; margin-bottom: 20px;
        }
        .entity-pills { display: flex; gap: 8px; flex-wrap: wrap; }
        .entity-pill {
            padding: 10px 20px; border-radius: 25px; font-size: 0.85rem;
            font-weight: 600; cursor: pointer; transition: all 0.3s ease;
            border: 2px solid transparent; display: flex; align-items: center; gap: 8px;
        }
        .entity-pill.ddd { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: 2px solid #b91c1c; }
        .entity-pill.ljbb { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: 2px solid #1d4ed8; }
        .entity-pill.mbb { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: 2px solid #6d28d9; }
        .entity-pill.ubb { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: 2px solid #b45309; }
        .entity-pill.active { transform: scale(1.08); box-shadow: 0 6px 20px rgba(0,0,0,0.4); }
        .entity-pill:not(.active) { opacity: 0.7; }
        .entity-pill .count {
            background: rgba(255,255,255,0.3); padding: 2px 8px;
            border-radius: 10px; font-size: 0.75rem;
        }

        /* Tabs */
        .tabs {
            display: flex; gap: 5px; margin-bottom: 25px; background: var(--card-bg);
            padding: 6px; border-radius: 14px; box-shadow: var(--shadow); width: fit-content;
        }
        .tab {
            padding: 10px 22px; border: none; background: transparent; border-radius: 10px;
            font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif; color: #6b7280;
        }
        .tab:hover { background: #f3f4f6; }
        .tab.active { background: var(--bg-gradient); color: white; }
        .tab:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Stats Cards */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px; margin-bottom: 25px;
        }
        .stat-card {
            background: var(--card-bg); border-radius: 16px; padding: 20px;
            box-shadow: var(--shadow); position: relative; overflow: hidden;
        }
        .stat-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0;
            height: 4px; border-radius: 16px 16px 0 0;
        }
        .stat-card.primary::before { background: linear-gradient(90deg, #6366f1, #818cf8); }
        .stat-card.success::before { background: linear-gradient(90deg, #10b981, #34d399); }
        .stat-card.warning::before { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .stat-card.info::before { background: linear-gradient(90deg, #06b6d4, #22d3ee); }
        .stat-card.danger::before { background: linear-gradient(90deg, #ef4444, #f87171); }
        .stat-card.secondary::before { background: linear-gradient(90deg, #ec4899, #f472b6); }
        .stat-card h3 {
            font-size: 0.7rem; color: #6b7280; font-weight: 600; margin-bottom: 8px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .stat-card .value { font-size: 1.6rem; font-weight: 700; color: #1f2937; }
        .stat-card .sub-value { font-size: 0.75rem; color: #9ca3af; margin-top: 3px; }

        /* Charts */
        .charts-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px; margin-bottom: 25px;
        }
        .chart-card {
            background: var(--card-bg); border-radius: 16px; padding: 20px; box-shadow: var(--shadow);
        }
        .chart-card h3 { font-size: 0.95rem; font-weight: 600; margin-bottom: 15px; color: #374151; }
        .chart-container { position: relative; height: 250px; }

        /* Filter Section */
        .filter-section {
            background: var(--card-bg); border-radius: 16px; padding: 20px 25px;
            margin-bottom: 25px; box-shadow: var(--shadow);
            display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px;
            align-items: end;
        }
        .filter-group label {
            display: block; font-weight: 600; margin-bottom: 6px; color: #374151;
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .filter-group select, .filter-group input {
            width: 100%; padding: 10px 14px; border: 2px solid #e5e7eb;
            border-radius: 10px; font-size: 0.85rem; font-family: 'Poppins', sans-serif;
            background: white; transition: all 0.3s ease;
        }
        .filter-group select:focus, .filter-group input:focus {
            outline: none; border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        /* Store Summary */
        .store-summary {
            background: var(--card-bg); border-radius: 16px; padding: 20px;
            margin-bottom: 25px; box-shadow: var(--shadow);
        }
        .store-summary h3 { font-size: 0.95rem; font-weight: 600; margin-bottom: 15px; }
        .store-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;
            max-height: 300px; overflow-y: auto;
        }
        .store-item {
            background: #f8fafc; border-radius: 10px; padding: 12px 15px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: all 0.2s ease; border: 2px solid transparent;
        }
        .store-item:hover { background: #f1f5f9; border-color: var(--primary-light); }
        .store-item.active { background: #eef2ff; border-color: var(--primary); }
        .store-item .store-name { font-size: 0.8rem; font-weight: 500; color: #374151; }
        .store-item .store-stock { font-size: 0.9rem; font-weight: 700; color: var(--primary); }

        /* Table */
        .table-section {
            background: var(--card-bg); border-radius: 16px; box-shadow: var(--shadow); overflow: hidden;
        }
        .table-header {
            padding: 18px 22px; border-bottom: 1px solid #e5e7eb;
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; gap: 12px;
        }
        .table-header h3 { font-size: 0.95rem; font-weight: 600; color: #374151; }
        .search-box { position: relative; }
        .search-box input {
            padding: 9px 14px 9px 38px; border: 2px solid #e5e7eb; border-radius: 10px;
            font-size: 0.85rem; width: 260px; font-family: 'Poppins', sans-serif;
        }
        .search-box::before {
            content: 'üîç'; position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 0.85rem;
        }
        .table-wrapper { overflow-x: auto; max-height: 500px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        th {
            color: white; padding: 12px 14px; text-align: left; font-size: 0.75rem;
            font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
            position: sticky; top: 0; z-index: 10; cursor: pointer;
        }
        .retail-table th { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
        .retail-table th:hover { background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); }
        .warehouse-table th { background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%); }
        .warehouse-table th:hover { background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%); }
        td { padding: 11px 14px; border-bottom: 1px solid #f3f4f6; font-size: 0.82rem; }
        tr:hover { background: #f8fafc; }
        tr:nth-child(even) { background: #fafbfc; }

        .stock-badge {
            display: inline-block; padding: 3px 10px; border-radius: 15px;
            font-size: 0.7rem; font-weight: 600;
        }
        .stock-high { background: #d1fae5; color: #065f46; }
        .stock-medium { background: #fef3c7; color: #92400e; }
        .stock-low { background: #fee2e2; color: #991b1b; }
        .stock-negative { background: #fecaca; color: #7f1d1d; }

        .pagination {
            display: flex; justify-content: center; align-items: center; gap: 10px;
            padding: 15px; border-top: 1px solid #e5e7eb;
        }
        .pagination button {
            padding: 8px 16px; border: 1px solid #e5e7eb; background: white;
            border-radius: 8px; cursor: pointer; font-family: 'Poppins', sans-serif;
        }
        .pagination button:hover { background: #f3f4f6; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>üìä Monitoring Stock Retail & Warehouse</h1>
            <p>Zuma Indonesia - Real-time dari Supabase</p>
        </div>
        <div class="date" id="currentDate"></div>
    </div>

    <div class="container">
        <div id="loadingIndicator" class="loading">
            <div class="loading-spinner"></div>
            <p>Memuat data dari Supabase...</p>
        </div>

        <div id="mainContent" style="display: none;">
            <!-- Entity Pills -->
            <div class="entity-section">
                <div class="entity-pills">
                    <div class="entity-pill ddd active" data-entity="DDD" onclick="selectEntity('DDD')">
                        üè¢ DDD <span class="count" id="countDDD">0</span>
                    </div>
                    <div class="entity-pill ljbb" data-entity="LJBB" onclick="selectEntity('LJBB')">
                        üè¢ LJBB <span class="count" id="countLJBB">0</span>
                    </div>
                    <div class="entity-pill mbb" data-entity="MBB" onclick="selectEntity('MBB')">
                        üè¢ MBB <span class="count" id="countMBB">0</span>
                    </div>
                    <div class="entity-pill ubb" data-entity="UBB" onclick="selectEntity('UBB')">
                        üè¢ UBB <span class="count" id="countUBB">0</span>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid" id="statsGrid"></div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" id="tabRetail" onclick="switchTab('retail')">üè™ Stock Retail</button>
                <button class="tab" id="tabWarehouse" onclick="switchTab('warehouse')">üè≠ Stock Warehouse</button>
            </div>

            <!-- Retail Tab -->
            <div id="retailTab" class="tab-content active">
                <!-- Store Summary -->
                <div class="store-summary" id="storeSummary">
                    <h3>üìç Store Summary - <span id="storeCount">0</span> Stores</h3>
                    <div class="store-grid" id="storeGrid"></div>
                </div>

                <!-- Charts -->
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3>Top 10 Store by Total Stock</h3>
                        <div class="chart-container"><canvas id="topStoresChart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <h3>Stock Distribution</h3>
                        <div class="chart-container"><canvas id="storeDistChart"></canvas></div>
                    </div>
                </div>

                <!-- Filter -->
                <div class="filter-section">
                    <div class="filter-group">
                        <label>Cari SKU/Produk</label>
                        <input type="text" id="retailSearch" placeholder="Ketik untuk mencari..." oninput="filterData('retail')">
                    </div>
                    <div class="filter-group">
                        <label>Store</label>
                        <select id="retailStoreFilter" onchange="filterData('retail')">
                            <option value="">Semua Store</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Stock Status</label>
                        <select id="retailStockFilter" onchange="filterData('retail')">
                            <option value="">Semua</option>
                            <option value="high">High (>50)</option>
                            <option value="medium">Medium (10-50)</option>
                            <option value="low">Low (<10)</option>
                        </select>
                    </div>
                </div>

                <!-- Table -->
                <div class="table-section">
                    <div class="table-header">
                        <h3>üìã Detail Stock Retail (<span id="retailCount">0</span> items)</h3>
                        <div class="search-box">
                            <input type="text" placeholder="Quick search..." oninput="filterData('retail')" id="retailQuickSearch">
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="retail-table">
                            <thead>
                                <tr>
                                    <th onclick="sortTable('retail', 'sku_code')">SKU Code</th>
                                    <th onclick="sortTable('retail', 'product_name')">Product Name</th>
                                    <th onclick="sortTable('retail', 'location_name')">Store</th>
                                    <th onclick="sortTable('retail', 'quantity')">Qty</th>
                                </tr>
                            </thead>
                            <tbody id="retailTableBody"></tbody>
                        </table>
                    </div>
                    <div class="pagination">
                        <button onclick="changePage('retail', -1)" id="retailPrevBtn">‚Üê Prev</button>
                        <span id="retailPageInfo">Page 1</span>
                        <button onclick="changePage('retail', 1)" id="retailNextBtn">Next ‚Üí</button>
                    </div>
                </div>
            </div>

            <!-- Warehouse Tab -->
            <div id="warehouseTab" class="tab-content">
                <!-- Charts -->
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3>Stock per Warehouse</h3>
                        <div class="chart-container"><canvas id="warehouseChart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <h3>Warehouse Distribution</h3>
                        <div class="chart-container"><canvas id="warehouseDistChart"></canvas></div>
                    </div>
                </div>

                <!-- Filter -->
                <div class="filter-section">
                    <div class="filter-group">
                        <label>Cari SKU/Produk</label>
                        <input type="text" id="warehouseSearch" placeholder="Ketik untuk mencari..." oninput="filterData('warehouse')">
                    </div>
                    <div class="filter-group">
                        <label>Warehouse</label>
                        <select id="warehouseFilter" onchange="filterData('warehouse')">
                            <option value="">Semua Warehouse</option>
                        </select>
                    </div>
                </div>

                <!-- Table -->
                <div class="table-section">
                    <div class="table-header">
                        <h3>üìã Detail Stock Warehouse (<span id="warehouseCount">0</span> items)</h3>
                        <div class="search-box">
                            <input type="text" placeholder="Quick search..." oninput="filterData('warehouse')" id="warehouseQuickSearch">
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="warehouse-table">
                            <thead>
                                <tr>
                                    <th onclick="sortTable('warehouse', 'sku_code')">SKU Code</th>
                                    <th onclick="sortTable('warehouse', 'product_name')">Product Name</th>
                                    <th onclick="sortTable('warehouse', 'location_name')">Warehouse</th>
                                    <th onclick="sortTable('warehouse', 'quantity')">Qty</th>
                                </tr>
                            </thead>
                            <tbody id="warehouseTableBody"></tbody>
                        </table>
                    </div>
                    <div class="pagination">
                        <button onclick="changePage('warehouse', -1)" id="warehousePrevBtn">‚Üê Prev</button>
                        <span id="warehousePageInfo">Page 1</span>
                        <button onclick="changePage('warehouse', 1)" id="warehouseNextBtn">Next ‚Üí</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Config
        const SUPABASE_URL = 'https://usxmptrqsovoxvrburvp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzeG1wdHJxc292b3h2cmJ1cnZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxODA2NzMsImV4cCI6MjA4NDc1NjY3M30.JkznqF6YWFgg22ta9F8feZuFbRPkHqkpDnJdm2G4C5Q';

        // Data storage by entity
        let allData = { DDD: { retail: [], warehouse: [] }, LJBB: { warehouse: [] }, MBB: { warehouse: [] }, UBB: { warehouse: [] } };
        let currentEntity = 'DDD';
        let filteredRetail = [];
        let filteredWarehouse = [];

        // Pagination & Sort
        const PAGE_SIZE = 100;
        let retailPage = 1, warehousePage = 1;
        let retailSort = { col: 'location_name', dir: 'asc' };
        let warehouseSort = { col: 'location_name', dir: 'asc' };

        // Charts
        let charts = {};

        // Set date
        document.getElementById('currentDate').innerHTML = `
            <div>Data Realtime</div>
            <div>${new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
        `;

        // Fetch from Supabase
        async function fetchData(filters) {
            const url = `${SUPABASE_URL}/rest/v1/inventory?${filters}&limit=50000`;
            const response = await fetch(url, {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
            });
            return response.json();
        }

        // Load all data
        async function loadAllData() {
            try {
                // Load all retail (DDD only)
                const retail = await fetchData('location_type=eq.retail&entity=eq.DDD&order=location_name');
                allData.DDD.retail = retail;

                // Load warehouse for each entity
                for (const entity of ['DDD', 'LJBB', 'MBB', 'UBB']) {
                    const wh = await fetchData(`location_type=eq.warehouse&entity=eq.${entity}&order=location_name`);
                    allData[entity].warehouse = wh;
                }

                // Update entity counts
                updateEntityCounts();

                // Initial render for DDD
                selectEntity('DDD');

                // Hide loading, show content
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loadingIndicator').innerHTML = `
                    <p style="color: #ef4444;">Error: ${error.message}</p>
                    <button onclick="loadAllData()" style="margin-top:15px;padding:10px 20px;cursor:pointer;">Retry</button>
                `;
            }
        }

        // Update entity pill counts
        function updateEntityCounts() {
            const dddTotal = allData.DDD.retail.reduce((s, d) => s + Math.max(0, d.quantity), 0) +
                           allData.DDD.warehouse.reduce((s, d) => s + Math.max(0, d.quantity), 0);
            const ljbbTotal = allData.LJBB.warehouse.reduce((s, d) => s + Math.max(0, d.quantity), 0);
            const mbbTotal = allData.MBB.warehouse.reduce((s, d) => s + Math.max(0, d.quantity), 0);
            const ubbTotal = allData.UBB.warehouse.reduce((s, d) => s + Math.max(0, d.quantity), 0);

            document.getElementById('countDDD').textContent = dddTotal.toLocaleString();
            document.getElementById('countLJBB').textContent = ljbbTotal.toLocaleString();
            document.getElementById('countMBB').textContent = mbbTotal.toLocaleString();
            document.getElementById('countUBB').textContent = ubbTotal.toLocaleString();
        }

        // Select entity
        function selectEntity(entity) {
            currentEntity = entity;

            // Update pills
            document.querySelectorAll('.entity-pill').forEach(p => p.classList.remove('active'));
            document.querySelector(`.entity-pill[data-entity="${entity}"]`).classList.add('active');

            // DDD has retail, others don't
            const hasRetail = (entity === 'DDD');
            document.getElementById('tabRetail').disabled = !hasRetail;
            document.getElementById('storeSummary').classList.toggle('hidden', !hasRetail);

            if (!hasRetail && document.getElementById('retailTab').classList.contains('active')) {
                switchTab('warehouse');
            }

            // Reset filters
            filteredRetail = [...(allData[entity].retail || [])];
            filteredWarehouse = [...allData[entity].warehouse];
            retailPage = 1;
            warehousePage = 1;

            // Update UI
            updateStats();
            populateFilters();
            updateStoreGrid();
            renderTable('retail');
            renderTable('warehouse');
            updateCharts();
        }

        // Update stats
        function updateStats() {
            const retail = allData[currentEntity].retail || [];
            const warehouse = allData[currentEntity].warehouse;

            const retailQty = retail.reduce((s, d) => s + Math.max(0, d.quantity), 0);
            const warehouseQty = warehouse.reduce((s, d) => s + Math.max(0, d.quantity), 0);
            const stores = new Set(retail.map(d => d.location_name)).size;
            const warehouses = new Set(warehouse.map(d => d.location_name)).size;
            const skus = new Set([...retail, ...warehouse].map(d => d.sku_code)).size;

            let html = '';
            if (currentEntity === 'DDD') {
                html += `<div class="stat-card primary"><h3>Stock Retail</h3><div class="value">${retailQty.toLocaleString()}</div><div class="sub-value">${retail.length.toLocaleString()} items</div></div>`;
            }
            html += `
                <div class="stat-card success"><h3>Stock Warehouse</h3><div class="value">${warehouseQty.toLocaleString()}</div><div class="sub-value">${warehouse.length.toLocaleString()} items</div></div>
                ${currentEntity === 'DDD' ? `<div class="stat-card info"><h3>Jumlah Store</h3><div class="value">${stores}</div></div>` : ''}
                <div class="stat-card warning"><h3>Jumlah Warehouse</h3><div class="value">${warehouses}</div></div>
                <div class="stat-card danger"><h3>Total SKU</h3><div class="value">${skus.toLocaleString()}</div></div>
            `;
            document.getElementById('statsGrid').innerHTML = html;
        }

        // Populate filter dropdowns
        function populateFilters() {
            // Stores (retail)
            const storeSelect = document.getElementById('retailStoreFilter');
            storeSelect.innerHTML = '<option value="">Semua Store</option>';
            const stores = [...new Set((allData[currentEntity].retail || []).map(d => d.location_name))].sort();
            stores.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s; opt.textContent = s;
                storeSelect.appendChild(opt);
            });

            // Warehouses
            const whSelect = document.getElementById('warehouseFilter');
            whSelect.innerHTML = '<option value="">Semua Warehouse</option>';
            const whs = [...new Set(allData[currentEntity].warehouse.map(d => d.location_name))].sort();
            whs.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w; opt.textContent = w;
                whSelect.appendChild(opt);
            });
        }

        // Update store grid
        function updateStoreGrid() {
            const retail = allData[currentEntity].retail || [];
            const storeStocks = {};
            retail.forEach(d => {
                if (!storeStocks[d.location_name]) storeStocks[d.location_name] = 0;
                if (d.quantity > 0) storeStocks[d.location_name] += d.quantity;
            });

            const sorted = Object.entries(storeStocks).sort((a, b) => b[1] - a[1]);
            document.getElementById('storeCount').textContent = sorted.length;

            document.getElementById('storeGrid').innerHTML = sorted.map(([name, qty]) => `
                <div class="store-item" onclick="filterByStore('${name}')">
                    <span class="store-name">${name.replace('ZUMA ', '').replace('Zuma ', '')}</span>
                    <span class="store-stock">${qty.toLocaleString()}</span>
                </div>
            `).join('');
        }

        function filterByStore(storeName) {
            document.getElementById('retailStoreFilter').value = storeName;
            filterData('retail');
        }

        // Filter data
        function filterData(type) {
            const search = document.getElementById(type === 'retail' ? 'retailSearch' : 'warehouseSearch').value.toLowerCase();
            const quickSearch = document.getElementById(type === 'retail' ? 'retailQuickSearch' : 'warehouseQuickSearch').value.toLowerCase();
            const searchTerm = search || quickSearch;

            if (type === 'retail') {
                const store = document.getElementById('retailStoreFilter').value;
                const stockFilter = document.getElementById('retailStockFilter').value;
                const source = allData[currentEntity].retail || [];

                filteredRetail = source.filter(d => {
                    const matchSearch = !searchTerm || d.sku_code.toLowerCase().includes(searchTerm) || d.product_name.toLowerCase().includes(searchTerm);
                    const matchStore = !store || d.location_name === store;
                    let matchStock = true;
                    if (stockFilter === 'high') matchStock = d.quantity > 50;
                    else if (stockFilter === 'medium') matchStock = d.quantity >= 10 && d.quantity <= 50;
                    else if (stockFilter === 'low') matchStock = d.quantity < 10;
                    return matchSearch && matchStore && matchStock;
                });
                retailPage = 1;
                renderTable('retail');
            } else {
                const wh = document.getElementById('warehouseFilter').value;
                const source = allData[currentEntity].warehouse;

                filteredWarehouse = source.filter(d => {
                    const matchSearch = !searchTerm || d.sku_code.toLowerCase().includes(searchTerm) || d.product_name.toLowerCase().includes(searchTerm);
                    const matchWh = !wh || d.location_name === wh;
                    return matchSearch && matchWh;
                });
                warehousePage = 1;
                renderTable('warehouse');
            }
        }

        // Sort table
        function sortTable(type, col) {
            const sort = type === 'retail' ? retailSort : warehouseSort;
            if (sort.col === col) sort.dir = sort.dir === 'asc' ? 'desc' : 'asc';
            else { sort.col = col; sort.dir = 'asc'; }

            const data = type === 'retail' ? filteredRetail : filteredWarehouse;
            data.sort((a, b) => {
                let va = a[col], vb = b[col];
                if (typeof va === 'string') { va = va.toLowerCase(); vb = vb.toLowerCase(); }
                return sort.dir === 'asc' ? (va > vb ? 1 : -1) : (va < vb ? 1 : -1);
            });

            renderTable(type);
        }

        // Render table
        function renderTable(type) {
            const data = type === 'retail' ? filteredRetail : filteredWarehouse;
            const page = type === 'retail' ? retailPage : warehousePage;
            const start = (page - 1) * PAGE_SIZE;
            const pageData = data.slice(start, start + PAGE_SIZE);

            const tbody = document.getElementById(type === 'retail' ? 'retailTableBody' : 'warehouseTableBody');
            tbody.innerHTML = pageData.map(d => `
                <tr>
                    <td><strong>${d.sku_code}</strong></td>
                    <td>${d.product_name || '-'}</td>
                    <td>${d.location_name}</td>
                    <td><span class="stock-badge ${getStockClass(d.quantity)}">${d.quantity}</span></td>
                </tr>
            `).join('');

            document.getElementById(type === 'retail' ? 'retailCount' : 'warehouseCount').textContent = data.length.toLocaleString();

            const totalPages = Math.ceil(data.length / PAGE_SIZE) || 1;
            document.getElementById(type === 'retail' ? 'retailPageInfo' : 'warehousePageInfo').textContent = `Page ${page} of ${totalPages}`;
            document.getElementById(type === 'retail' ? 'retailPrevBtn' : 'warehousePrevBtn').disabled = page === 1;
            document.getElementById(type === 'retail' ? 'retailNextBtn' : 'warehouseNextBtn').disabled = page >= totalPages;
        }

        function getStockClass(qty) {
            if (qty < 0) return 'stock-negative';
            if (qty < 10) return 'stock-low';
            if (qty <= 50) return 'stock-medium';
            return 'stock-high';
        }

        function changePage(type, delta) {
            if (type === 'retail') {
                retailPage += delta;
                renderTable('retail');
            } else {
                warehousePage += delta;
                renderTable('warehouse');
            }
        }

        // Switch tab
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            if (tab === 'retail') {
                document.getElementById('tabRetail').classList.add('active');
                document.getElementById('retailTab').classList.add('active');
            } else {
                document.getElementById('tabWarehouse').classList.add('active');
                document.getElementById('warehouseTab').classList.add('active');
            }
        }

        // Update charts
        function updateCharts() {
            // Destroy existing
            Object.values(charts).forEach(c => c && c.destroy());

            const retail = allData[currentEntity].retail || [];
            const warehouse = allData[currentEntity].warehouse;

            // Top stores chart (retail)
            if (retail.length > 0) {
                const storeStocks = {};
                retail.forEach(d => {
                    if (!storeStocks[d.location_name]) storeStocks[d.location_name] = 0;
                    if (d.quantity > 0) storeStocks[d.location_name] += d.quantity;
                });
                const topStores = Object.entries(storeStocks).sort((a, b) => b[1] - a[1]).slice(0, 10);

                charts.topStores = new Chart(document.getElementById('topStoresChart'), {
                    type: 'bar',
                    data: {
                        labels: topStores.map(s => s[0].replace('ZUMA ', '').replace('Zuma ', '')),
                        datasets: [{ label: 'Stock', data: topStores.map(s => s[1]), backgroundColor: 'rgba(99, 102, 241, 0.8)', borderRadius: 6 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });

                const top5 = topStores.slice(0, 5);
                const others = topStores.slice(5).reduce((s, x) => s + x[1], 0);
                charts.storeDist = new Chart(document.getElementById('storeDistChart'), {
                    type: 'doughnut',
                    data: {
                        labels: [...top5.map(s => s[0].replace('ZUMA ', '').replace('Zuma ', '')), 'Others'],
                        datasets: [{ data: [...top5.map(s => s[1]), others], backgroundColor: ['#6366f1', '#ec4899', '#10b981', '#f59e0b', '#06b6d4', '#9ca3af'] }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            // Warehouse charts
            const whStocks = {};
            warehouse.forEach(d => {
                if (!whStocks[d.location_name]) whStocks[d.location_name] = 0;
                if (d.quantity > 0) whStocks[d.location_name] += d.quantity;
            });
            const whSorted = Object.entries(whStocks).sort((a, b) => b[1] - a[1]);

            charts.warehouse = new Chart(document.getElementById('warehouseChart'), {
                type: 'bar',
                data: {
                    labels: whSorted.map(w => w[0].replace('Warehouse ', '')),
                    datasets: [{ label: 'Stock', data: whSorted.map(w => w[1]), backgroundColor: 'rgba(20, 184, 166, 0.8)', borderRadius: 6 }]
                },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } }
            });

            charts.whDist = new Chart(document.getElementById('warehouseDistChart'), {
                type: 'pie',
                data: {
                    labels: whSorted.slice(0, 6).map(w => w[0].replace('Warehouse ', '')),
                    datasets: [{ data: whSorted.slice(0, 6).map(w => w[1]), backgroundColor: ['#14b8a6', '#0ea5e9', '#8b5cf6', '#f43f5e', '#eab308', '#84cc16'] }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // Initialize
        loadAllData();
    </script>
</body>
</html>
